<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DFS Optimizer ‚Äì Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 80px 16px 24px;
      color: #222;
    }

    .nav {
      position: fixed;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 10px 24px;
      border-radius: 999px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      display: flex;
      gap: 16px;
      z-index: 1000;
    }

    .nav a {
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      transition: all 0.2s;
    }

    .nav a.active {
      background: #667eea;
      color: #fff;
    }

    .nav a:hover {
      background: rgba(102,126,234,0.1);
    }

    .page {
      max-width: 900px;
      margin: 0 auto;
    }

    .card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.25);
      padding: 24px 20px;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .section-title span.icon {
      font-size: 22px;
    }

    .field-group {
      margin-bottom: 16px;
    }

    .field-label {
      font-size: 13px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }

    .field-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .field-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102,126,234,0.2);
    }

    .btn-primary {
      width: 100%;
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .status-message {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.4;
    }

    .status-error {
      background: #fdecea;
      color: #b00020;
      border: 1px solid #f5c2c7;
    }

    .status-success {
      background: #e9f7ef;
      color: #1e7e34;
      border: 1px solid #c3e6cb;
    }

    .status-info {
      background: #e9f2ff;
      color: #1a56b5;
      border: 1px solid #c0d8ff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }

    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f5f7ff;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      color: #555;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .weights-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }

    .weights-header small {
      font-size: 11px;
      color: #888;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      color: #555;
      background: #f1f3ff;
    }

    .lineup-title {
      margin-top: 16px;
      font-size: 15px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <nav class="nav">
    <a href="/" >üèÄ NBA</a>
    <a href="/nfl.html">üèà NFL</a>
    <a href="/dashboard.html" class="active">üìä Dashboard</a>
  </nav>

  <main class="page">
    <section class="card">
      <h1>üìä DFS Learning Dashboard</h1>
      <p class="subtitle">
        Paste an Optimizer job ID after a slate finishes to load the lineup,
        compare to actual results, and iteratively improve your projections.
      </p>

      <!-- Learn from Results -->
      <div>
        <h2 class="section-title">
          <span class="icon">üìà</span>
          <span>Learn from Results</span>
        </h2>

        <div class="field-group">
          <div class="field-label">Optimizer Job ID</div>
          <input
            id="optimizerJobId"
            class="field-input"
            type="text"
            placeholder="e.g. 3d053f5d-d61a-44a6-a9f9-933f19770b8f"
          />
        </div>

        <div class="field-group">
          <div class="field-label">Slate Date (optional)</div>
          <input
            id="slateDate"
            class="field-input"
            type="date"
          />
        </div>

        <button id="analyzeBtn" class="btn-primary">
          <span>üß† Analyze Results & Load Lineup</span>
        </button>

        <div id="learnStatus" class="status-message status-info" style="display:none;">
        </div>

        <div id="learnResult"></div>
      </div>
    </section>

    <!-- Current weights card -->
    <section class="card">
      <div class="weights-header">
        <h2 class="section-title">
          <span class="icon">‚öñÔ∏è</span>
          <span>Current Projection Weights</span>
        </h2>
        <small id="weightsUpdated"></small>
      </div>

      <div id="weightsStatus" class="status-message status-info" style="display:none;">
        Loading weights‚Ä¶
      </div>

      <table id="weightsTable" style="display:none;">
        <thead>
          <tr>
            <th>Factor</th>
            <th>Weight</th>
            <th>Impact</th>
          </tr>
        </thead>
        <tbody id="weightsBody"></tbody>
      </table>
    </section>
  </main>

  <script>
    // ---------- Helpers ----------
    function showStatus(el, message, type) {
      el.textContent = message;
      el.className = 'status-message ' + type;
      el.style.display = message ? 'block' : 'none';
    }

    // ---------- Load weights from /api/dashboard ----------
    async function loadWeights() {
      const statusEl = document.getElementById('weightsStatus');
      const table = document.getElementById('weightsTable');
      const body = document.getElementById('weightsBody');
      const updatedEl = document.getElementById('weightsUpdated');

      showStatus(statusEl, 'Loading weights‚Ä¶', 'status-info');
      table.style.display = 'none';

      try {
        const resp = await fetch('/api/dashboard');
        const data = await resp.json();

        if (!data.ok) {
          showStatus(statusEl, data.error || 'Failed to load weights', 'status-error');
          return;
        }

        const weights = data.current_weights || data.currentWeights || {};
        const rows = [];

        const labelMap = {
          W_SALARY_PROXY: 'Salary Baseline',
          W_MATCHUP: 'Matchup Quality',
          W_PACE: 'Game Pace',
          W_REST: 'Rest/Fatigue',
          W_OPPORTUNITY: 'Opportunity Boost',
          W_SENTIMENT: 'News/Momentum'
        };

        const impactMap = {
          W_SALARY_PROXY: 'High',
          W_MATCHUP: 'Medium',
          W_PACE: 'Low',
          W_REST: 'Low',
          W_OPPORTUNITY: 'Low',
          W_SENTIMENT: 'Low'
        };

        Object.entries(weights).forEach(([key, value]) => {
          const label = labelMap[key] || key;
          const impact = impactMap[key] || '';
          rows.push(
            `<tr>
              <td>${label}</td>
              <td>${(value * 100).toFixed(1)}%</td>
              <td><span class="pill">${impact}</span></td>
            </tr>`
          );
        });

        body.innerHTML = rows.join('');
        table.style.display = 'table';
        statusEl.style.display = 'none';

        if (data.last_updated) {
          const d = new Date(data.last_updated);
          updatedEl.textContent = 'Last updated: ' + d.toLocaleString();
        }
      } catch (err) {
        console.error('Weights load error', err);
        showStatus(statusEl, err.message, 'status-error');
      }
    }

    // ---------- Learn from Results (calls /api/tracker) ----------
    async function setupLearning() {
      const jobInput = document.getElementById('optimizerJobId');
      const dateInput = document.getElementById('slateDate');
      const btn = document.getElementById('analyzeBtn');
      const statusEl = document.getElementById('learnStatus');
      const resultEl = document.getElementById('learnResult');

      // Default date to today
      const today = new Date().toISOString().slice(0, 10);
      dateInput.value = today;

      btn.addEventListener('click', async () => {
        const jobId = jobInput.value.trim();
        const slateDate = dateInput.value || null;

        resultEl.innerHTML = '';
        if (!jobId) {
          showStatus(statusEl, 'Please paste an optimizer job ID.', 'status-error');
          return;
        }

        btn.disabled = true;
        showStatus(statusEl, 'Loading optimizer lineup‚Ä¶', 'status-info');

        try {
          const resp = await fetch('/api/tracker', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              optimizer_job_id: jobId,   // must match api/tracker
              slate_date: slateDate
            })
          });

          const data = await resp.json();
          console.log('TRACKER response:', data);

          if (!data.ok) {
            showStatus(statusEl, data.error || 'Unknown error', 'status-error');
            btn.disabled = false;
            return;
          }

          showStatus(
            statusEl,
            'Lineup loaded. Next step: add UI inputs for actual scores & winning lineup.',
            'status-success'
          );

          const lineup = data.lineup || [];
          const stats = data.stats || {};
          const recommendations = data.recommendations || [];

          if (!lineup.length) {
            resultEl.innerHTML = '<p class="lineup-title">No lineup found on this job.</p>';
            btn.disabled = false;
            return;
          }

          const rows = lineup.map((p) => `
            <tr>
              <td>${p.slot}</td>
              <td>${p.name}</td>
              <td>${p.team || ''}</td>
              <td>${p.salary}</td>
              <td>${p.projection}</td>
              <td>${p.value}</td>
            </tr>
          `).join('');

          let statsHtml = '';
          if (Object.keys(stats).length) {
            statsHtml = `
              <p style="font-size:13px;margin-top:8px;color:#555;">
                Total projection: <strong>${stats.total_projection || 'N/A'}</strong> pts ¬∑
                Salary used: <strong>${stats.salary_used_pct || 'N/A'}</strong> ¬∑
                Total salary: <strong>${stats.total_salary || 'N/A'}</strong>
              </p>
            `;
          }

          let recHtml = '';
          if (recommendations.length) {
            recHtml = `
              <ul style="margin-top:10px;font-size:13px;color:#555;padding-left:18px;">
                ${recommendations.filter(Boolean).map((r) => `<li>${r}</li>`).join('')}
              </ul>
            `;
          }

          resultEl.innerHTML = `
            <p class="lineup-title">Optimized Lineup from Job <code>${data.optimizer_job_id}</code></p>
            ${statsHtml}
            <table>
              <thead>
                <tr>
                  <th>Pos</th>
                  <th>Player</th>
                  <th>Team</th>
                  <th>Salary</th>
                  <th>Proj</th>
                  <th>Val</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
            ${recHtml}
          `;

          btn.disabled = false;
        } catch (err) {
          console.error('Tracker error', err);
          showStatus(statusEl, err.message, 'status-error');
          btn.disabled = false;
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadWeights();
      setupLearning();
    });
  </script>
</body>
</html>
